(function(){var t,e,i=function(t,e){return function(){return t.apply(e,arguments)}},n=function(t,e){function i(){this.constructor=t}for(var n in e)o.call(e,n)&&(t[n]=e[n]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},o={}.hasOwnProperty;t={},t.Models={},t.Collections={},t.Views={},e="undefined"!=typeof exports&&null!==exports?exports:this,e.FellRace=t,t.Application=function(o){function r(n){var o;null==n&&(n={}),this.sendAuthenticationHeader=i(this.sendAuthenticationHeader,this),this.navigate=i(this.navigate,this),this.getCurrentCompetitor=i(this.getCurrentCompetitor,this),this.authPending=i(this.authPending,this),this.userConfirmed=i(this.userConfirmed,this),this.userSignedIn=i(this.userSignedIn,this),this.currentUser=i(this.currentUser,this),this.setMapOptions=i(this.setMapOptions,this),this.getMap=i(this.getMap,this),this.user_actions=i(this.user_actions,this),this.getCategories=i(this.getCategories,this),this.config=i(this.config,this),this.closeRight=i(this.closeRight,this),this.actionRegionSetup=i(this.actionRegionSetup,this),this.toPublicOrHome=i(this.toPublicOrHome,this),this.adminMapView=i(this.adminMapView,this),this.publicMapView=i(this.publicMapView,this),this.indexMapView=i(this.indexMapView,this),this.showRace=i(this.showRace,this),this.moveMapTo=i(this.moveMapTo,this),this.offsetX=i(this.offsetX,this),this.listenToToggle=i(this.listenToToggle,this),this.domain=i(this.domain,this),this.apiUrl=i(this.apiUrl,this),this.sync=i(this.sync,this),r.__super__.constructor.apply(this,arguments),this.original_backbone_sync=Backbone.sync,Backbone.sync=this.sync,e._fellrace=this,$.notify=function(t){return function(e,i){return t.vent.trigger(e,i)}}(this),$(document).ajaxSend(this.sendAuthenticationHeader),Backbone.Marionette.Renderer.render=this.render,this.addRegions(this.regions),this.actionRegionSetup(),this._config=new t.Config(n.config),this._api_url=this.config("api_url"),this._domain=this.config("domain"),"undefined"!=typeof Stripe&&null!==Stripe&&Stripe.setPublishableKey(this.config("stripe_publishable_key")),this.session=new t.Models.UserSession,this.race_publications=new t.Collections.RacePublications([]),this.race_publications.fetch({remove:!1}),this.future_instances=new t.Collections.PublicFutureInstances([]),this.past_instances=new t.Collections.PublicPastInstances([]),this.future_instances.fetch(),this.past_instances.fetch(),this.clubs=new t.Collections.Clubs([]),this.categories=new t.Collections.Categories([]),this.categories.fetch(),this.mapView=new t.Views.Map,this.gmapRegion.show(this.mapView),this.user_controlsRegion.show(new t.Views.UserControls),this.listenToToggle(),this.noticeRegion.show(new Notifier({model:this.vent,wait:4e3})),this.session.load(),this.router=new t.BaseRouter,this.content=$("#content"),o=$(window),Backbone.history.start({pushState:!0,root:"/"})}return n(r,o),r.prototype.regions={gmapRegion:"#gmap",contentRegion:"#content",mainRegion:"main",user_controlsRegion:"#user_controls",noticeRegion:"#notice",actionRegion:"#action",extraContentRegion:"section#extra"},r.prototype.months={full:["January","February","March","April","May","June","July","August","September","October","November","December"],"short":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]},r.prototype.open_drawer=!0,r.prototype.open_css={top:"",left:""},r.prototype.sync=function(t,e,i){return this.original_backbone_sync(t,e,i)},r.prototype.apiUrl=function(){return this._api_url},r.prototype.domain=function(){return this._domain},r.prototype.listenToToggle=function(){return $("#view_toggle").on("click",function(t){return function(){return t.content.hasClass("collapsed")?t.content.removeClass("collapsed"):t.content.addClass("collapsed")}}(this))},r.prototype.offsetX=function(){return this.open_drawer?-(this.content.width()-10)/2:-5},r.prototype.moveMapTo=function(t,e){return this.mapView.moveTo(t,e)},r.prototype.showRace=function(t){return this.mapView.showRace(t)},r.prototype.indexMapView=function(){return this.mapView.indexView()},r.prototype.publicMapView=function(){return this.mapView.publicView()},r.prototype.adminMapView=function(){return this.mapView.adminView()},r.prototype.toPublicOrHome=function(){var t;return _fellrace.navigate((null!=(t=Backbone.history.fragment.match(/admin(.+)/))?t[1]:void 0)||"/")},r.prototype.actionRegionSetup=function(){return this.actionRegion.on("show",function(t){return this.$el.show(),this.$el.find("a.close, a.hide, a.cancel").on("click",function(t){return function(){return t.trigger("close")}}(this))}).on("hide",function(t){return this.$el.hide()}).on("close",function(t){return this.$el.hide()}),$(document).keyup(function(t){return function(e){var i;return i=e.keyCode||e.which,27===i?t.actionRegion.close():13===i&&t.actionRegion.currentView?t.actionRegion.currentView.trigger("submit"):void 0}}(this))},r.prototype.closeRight=function(){return this.extraContentRegion.close()},r.prototype.config=function(t){return this._config.get(t)},r.prototype.getCategories=function(){return this.categories},r.prototype.render=function(t,e){var i;if(i="templates/"+t,null!=t){if(!JST[i])throw"Template '"+i+"' not found!";return JST[i](e)}return""},r.prototype.user_actions=function(){return{resetPassword:function(e){return function(i,n){return e.actionRegion.show(new t.Views.SessionPasswordForm({uid:i,token:n}))}}(this),requestReset:function(e){return function(){return e.actionRegion.show(new t.Views.SessionResetForm)}}(this),signOut:function(t){return function(){return t.session.reset()}}(this),signUp:function(e){return function(i){return e.actionRegion.show(new t.Views.UserSignupForm(i))}}(this),signUpForEvent:function(e){return function(){return e.actionRegion.show(new t.Views.UserSignupFormForRace)}}(this),signIn:function(e){return function(i){return e.actionRegion.show(new t.Views.SessionLoginForm(i))}}(this),confirm:function(e){return function(i,n){return e.actionRegion.show(new t.Views.SessionConfirmationForm({uid:i,token:n}))}}(this),reconfirm:function(e){return function(){return e.actionRegion.show(new t.Views.SessionReconfirmationForm)}}(this),requestConfirmation:function(e){return function(){return e.actionRegion.show(new t.Views.ConfirmationRequired)}}(this),signedUp:function(t){return function(){return $.notify("success","User account created"),t.actionRegion.close()}}(this),hideAction:function(t){return function(){return t.actionRegion.close()}}(this),menu:function(e){return function(){return e.actionRegion.show(new t.Views.UserActionMenu)}}(this)}},r.prototype.getMap=function(){var t;return null!=(t=this.mapView)?t.getMap():void 0},r.prototype.setMapOptions=function(t){var e;return null!=(e=this.mapView)?e.setOptions(t):void 0},r.prototype.currentUser=function(){return this.session.user},r.prototype.userSignedIn=function(){return this.session.signedIn()},r.prototype.userConfirmed=function(){return this.session.confirmed()},r.prototype.authPending=function(){return this.session.authPending()},r.prototype.getCurrentCompetitor=function(){var t;return null!=(t=this.currentUser())?t.getCompetitor():void 0},r.prototype.navigate=function(t,e){var i,n,o;return i=null!=e?e:{},o=i.trigger,n=i.replace,null==o&&(o=!0),null==n&&(n=!1),this.vent.off("login:changed"),Backbone.history.navigate(t,{trigger:o,replace:n})},r.prototype.sendAuthenticationHeader=function(t,e){var i,n;return(n=null!=(i=this.session)?i.authToken():void 0)?e.setRequestHeader("Authorization","Token token="+n):void 0},r}(Backbone.Marionette.Application)}).call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};Modernizr.addTest("filereader",function(){return!!(window.File&&window.FileList&&window.FileReader)}),Modernizr.addTest("formdata",function(){return!!window.FormData}),Modernizr.addTest("dropbox",function(){return"undefined"!=typeof Dropbox&&null!==Dropbox&&Dropbox.isBrowserSupported(),!0}),Modernizr.addTest("ios6plus",function(){var t;return t=window.navigator.userAgent,/iP(hone|od|ad)/.test(t)&&/[6789]_\d/.test(t)}),FellRace.Config=function(){function e(e){null==e&&(e={}),this.set=t(this.set,this),this.get=t(this.get,this),this.settings=t(this.settings,this),null==e.environment&&(e.environment=this.guessEnvironment()),this._settings=_.defaults(e,this[e.environment],this.defaults)}return e.prototype.defaults={api_url:"//api.fellrace.org.uk",domain:"fellrace.org.uk",stripe_publishable_key:"pk_live_dOxGZ6LC5I1womT8MgsDn3jB"},e.prototype.development={api_url:"http://api.fr.dev",domain:"fr.dev",stripe_publishable_key:"pk_test_orOZm4kTjBQOf5XB3RM01q0U"},e.prototype.guessEnvironment=function(){var t;return t=new RegExp(/fellrace\.org\.uk/),t.test(window.location.href)?"production":"development"},e.prototype.settings=function(){return this._settings},e.prototype.get=function(t){return this._settings[t]},e.prototype.set=function(t,e){return this._settings[t]=e},e}()}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e=function(t,e){function n(){this.constructor=t}for(var o in e)i.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},i={}.hasOwnProperty;FellRace.Router=function(i){function n(){this.route=t(this.route,this),this.handle=t(this.handle,this),this.handlers=[],n.__super__.constructor.apply(this,arguments)}return e(n,i),n.prototype._previous={},n.prototype.handle=function(t){return null==t&&(t="/"),_.any(this.handlers,function(e){return e.route.test(t)?(e.callback(t),!0):void 0})},n.prototype.route=function(t,e,i){return _.isRegExp(t)||(t=this._routeToRegExp(t)),_.isFunction(e)&&(i=e,e=""),null==i&&(i=this[e]),this.handlers.unshift({route:t,callback:function(n){return function(o){var r;return r=n._extractParameters(t,o),n.execute(i,r,e)}}(this)})},n}(Backbone.Router),FellRace.BaseRouter=function(i){function n(){return this.admin=t(this.admin,this),this["public"]=t(this["public"],this),n.__super__.constructor.apply(this,arguments)}return e(n,i),n.prototype.routes={"(/)":"public","admin(/*path)":"admin","*path":"public"},n.prototype._previous={},n.prototype["public"]=function(t){var e;return e="public"===this._previous.route?this._previous.router:new FellRace.PublicRouter,this._previous={route:"public",router:e},e.handle(t)},n.prototype.admin=function(t){var e;return _fellrace.userSignedIn()?("admin"===this._previous.route?this._previous.router.handle(t):(e=new FellRace.AdminRouter,e.handle(t),this._previous={route:"admin",router:e}),_fellrace.vent.once("login:changed",function(t){return function(){return _fellrace.toPublicOrHome()}}(this))):_fellrace.authPending()?_fellrace.vent.once("login:changed",function(e){return function(){return e.admin(t)}}(this)):_fellrace.toPublicOrHome()},n}(Backbone.Router),FellRace.PublicRouter=function(i){function n(){return this.page=t(this.page,this),this.resetPassword=t(this.resetPassword,this),this.confirmUser=t(this.confirmUser,this),this.users=t(this.users,this),this.clubs=t(this.clubs,this),this.competitors=t(this.competitors,this),this.racePublications=t(this.racePublications,this),this.events=t(this.events,this),this.index=t(this.index,this),n.__super__.constructor.apply(this,arguments)}return e(n,i),n.prototype.routes={"(/)":"index","events(/*path)":"events","races(/*path)":"racePublications","runners(/*path)":"competitors","clubs(/*path)":"clubs","users(/*path)":"users","confirm/:uid/:token(/)":"confirmUser","reset_password/:uid/:token(/)":"resetPassword","faq/:page_name(/)":"page","*path":"index"},n.prototype.initialize=function(){return _fellrace.publicMapView(),n.__super__.initialize.apply(this,arguments)},n.prototype.index=function(){var t;return"index"!==this._previous.route?(_fellrace.indexMapView(),t=new FellRace.Views.IndexView,_fellrace.mainRegion.show(t),_fellrace.closeRight(),this._previous={route:"index"}):void 0},n.prototype.events=function(t){return _fellrace.navigate("/races/"+t,{replace:!0})},n.prototype.racePublications=function(t){var e;return"race_publications"===this._previous.route?this._previous.view.handle(t):(e=new FellRace.Views.RacePublicationsLayout({path:t}),this._previous={route:"race_publications",view:e})},n.prototype.competitors=function(t){var e;return"competitors"===this._previous.route?this._previous.view.handle(t):(e=new FellRace.Views.CompetitorsLayout({path:t}),this._previous={route:"competitors",view:e})},n.prototype.clubs=function(t){var e;return"clubs"===this._previous.route?this._previous.view.handle(t):(e=new FellRace.Views.ClubsLayout({path:t}),this._previous={route:"clubs",view:e})},n.prototype.users=function(t){var e;return _fellrace.userSignedIn()?("users"===this._previous.route?this._previous.view.handle(t):(e=new FellRace.Views.UsersLayout({path:t}),this._previous={route:"users",view:e}),_fellrace.vent.on("login:changed",function(t){return function(){return _fellrace.navigate("/")}}(this))):_fellrace.authPending()?_fellrace.vent.once("login:changed",function(e){return function(){return e.users(t)}}(this)):_fellrace.navigate("/")},n.prototype.confirmUser=function(t,e){return this.index(),_fellrace.actionRegion.show(new FellRace.Views.SessionConfirmationForm({uid:t,token:e}))},n.prototype.resetPassword=function(t,e){return this.index(),_fellrace.actionRegion.show(new FellRace.Views.SessionPasswordForm({uid:t,token:e}))},n.prototype.page=function(t){var e;return e=new FellRace.Views.Page({template:"pages/"+t}),_fellrace.indexMapView(),_fellrace.mainRegion.show(e),_fellrace.closeRight()},n}(FellRace.Router),FellRace.AdminRouter=function(i){function n(){return this.competitors=t(this.competitors,this),this.clubs=t(this.clubs,this),this.races=t(this.races,this),n.__super__.constructor.apply(this,arguments)}return e(n,i),n.prototype.routes={"races(/*path)":"races","clubs(/*path)":"clubs","runners(/*path)":"competitors"},n.prototype.initialize=function(){return _fellrace.adminMapView(),n.__super__.initialize.apply(this,arguments)},n.prototype.races=function(t){var e;return"races"===this._previous.route?this._previous.view.handle(t):(e=new FellRace.Views.RacesLayout({path:t}),this._previous={route:"races",view:e})},n.prototype.clubs=function(t){var e;return"clubs"===this._previous.route?this._previous.view.handle(t):(e=new FellRace.Views.AdminClubsLayout({path:t}),this._previous={route:"clubs",view:e})},n.prototype.competitors=function(t){var e;return"competitors"===this._previous.route?this._previous.view.handle(t):(e=new FellRace.Views.AdminCompetitorsLayout({path:t}),this._previous={route:"competitors",view:e})},n}(FellRace.Router)}.call(this);